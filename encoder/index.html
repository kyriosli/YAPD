<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>PNG encoding demo</title>
<script src="../zlib.js"></script>
<script src="../png.js"></script>
<script src="png_encode.js"></script>
</head>
<body style="background: -webkit-canvas(squares)">
	<img src="../nodejs.png" />
	<script>
		~function() {
			var ctx = document.getCSSCanvasContext("2d", "squares", 16, 16);
			ctx.fillStyle = "#dbdbdb";
			ctx.fillRect(8, 0, 8, 8);
			ctx.fillRect(0, 8, 8, 8);
		}();
		document.querySelector('img').onload = function() {
			console.log('test image: ' + this.width + 'x' + this.height)
			var canvas = document.createElement('canvas');
			canvas.width = this.width;
			canvas.height = this.height;
			var ctx = canvas.getContext('2d');
			ctx.drawImage(this, 0, 0);
			console.time('canvas.toDataURL');
			var ret = canvas.toDataURL();
			var len = (ret.length - ret.indexOf(',') - 1) * 0.75;
			console.timeEnd('canvas.toDataURL');
			console.log('canvas.toDataURL: ' + len + 'B');

			console.time('PNG.encode: default options');
			PNG.encode(canvas, {}, function(buffer) {
				console.timeEnd('PNG.encode: default options');
				console.log('PNG.encode: ' + buffer.byteLength + 'B');
				append(buffer);
				/*
				new PNG(new Uint8Array(buffer)).onload = function() {
					document.body.appendChild(this.toCanvas());
				};
				 */

				console.time('PNG.encode: {platte:true, colors: 256, alpha: true}');
				PNG.encode(canvas, {
					platte : true,
					colors : 256
				}, function(buffer) {
					console.timeEnd('PNG.encode: {platte:true, colors: 256, alpha: true}');
					console.log('PNG.encode: ' + buffer.byteLength + 'B');
					append(buffer);

					new PNG(new Uint8Array(buffer)).onload = function() {
						document.body.appendChild(this.toCanvas());
					};
				});
			});
			this.width = 400;

			function append(buffer) {
				var img = new Image();
				img.src = URL.createObjectURL(new Blob([ buffer ], {
					type : 'image/png'
				}));
				img.onload = function() {
					URL.revokeObjectURL(this.src);
				}
				document.body.appendChild(img);

			}
		};
	</script>
</body>
</html>