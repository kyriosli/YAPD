<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>PNG encoding demo</title>
<script src="../zlib.js"></script>
<script src="../png.js"></script>
<script src="png_encode.js"></script>
</head>
<body style="background: -webkit-canvas(squares)">
	<img src="../rgba.png" /> 
	<script>
		~function() {
			var ctx = document.getCSSCanvasContext("2d", "squares", 16, 16);
			ctx.fillStyle = "#dbdbdb";
			ctx.fillRect(8, 0, 8, 8);
			ctx.fillRect(0, 8, 8, 8);
		}();
		document.querySelector('img').onload = function() {
			console.log('test image: ' + this.width + 'x' + this.height)
			var canvas = document.createElement('canvas');
			canvas.width = this.width;
			canvas.height = this.height;
			var ctx = canvas.getContext('2d');
			ctx.drawImage(this, 0, 0);
			console.time('canvas.toDataURL');
			var ret = canvas.toDataURL();
			var len = (ret.length - ret.indexOf(',') - 1) * 0.75;
			console.timeEnd('canvas.toDataURL');
			console.log('canvas.toDataURL: ' + len + 'B');

			console.time('PNG.encode: default options');
			PNG.encode(canvas, {}, function(buffer) {
				console.timeEnd('PNG.encode: default options');
				console.log('PNG.encode: ' + buffer.byteLength + 'B');
				console.log([].map.call(new Uint8Array(buffer, 0, 60), function(num) {
					return (num < 16 ? '0' : '') + num.toString(16).toUpperCase();
				}));
				var blob = new Blob([ buffer ], {
					type : 'image/png'
				});
				console.log(blob);

				var img = new Image();
				img.src = URL.createObjectURL(new Blob([ buffer ], {
					type : 'image/png'
				}));
				img.onload = function() {
					document.body.appendChild(this);
					this.width = 400;
					URL.revokeObjectURL(this.src);
				}
				new PNG(new Uint8Array(buffer)).onload = function() {
					document.body.appendChild(this.toCanvas());
				};
			});
			this.width = 400;
		};
	</script>
	<script src="../deflate.js"></script>
</body>
</html>